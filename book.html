<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Appointment - My Desire Salon</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.cdnfonts.com/css/backsteal" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#ff0000',
                        secondary: '#000000',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Backsteal', sans-serif;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        }

        .booking-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 0, 0, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .staff-card {
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid transparent;
            border-radius: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .staff-card:hover {
            border-color: #ff0000;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 0, 0, 0.3);
        }

        .staff-card.selected {
            border-color: #ff0000;
            background: rgba(255, 0, 0, 0.1);
        }

        .service-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .service-item:hover {
            border-color: #ff0000;
            background: rgba(255, 0, 0, 0.05);
        }

        .service-item.selected {
            border-color: #ff0000;
            background: rgba(255, 0, 0, 0.1);
        }

        .time-slot {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .time-slot:hover {
            border-color: #ff0000;
            background: rgba(255, 0, 0, 0.1);
        }

        .time-slot.selected {
            background: #ff0000;
            border-color: #ff0000;
            color: white;
        }

        .time-slot.unavailable {
            background: rgba(128, 128, 128, 0.3);
            border-color: rgba(128, 128, 128, 0.5);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .price-range {
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.1), rgba(255, 0, 0, 0.05));
            border: 1px solid rgba(255, 0, 0, 0.3);
            border-radius: 10px;
        }

        .glow-button {
            background: linear-gradient(135deg, #ff0000, #cc0000);
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        .glow-button:hover {
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.8);
            transform: translateY(-2px);
        }

        .calendar-day {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .calendar-day:hover {
            border-color: #ff0000;
            background: rgba(255, 0, 0, 0.1);
        }

        .calendar-day.selected {
            background: #ff0000;
            border-color: #ff0000;
            color: white;
        }

        .calendar-day.unavailable {
            background: rgba(128, 128, 128, 0.2);
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .error-message {
            color: #ff0000;
            background-color: rgba(255, 0, 0, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        
        .success-message {
            color: #00aa00;
            background-color: rgba(0, 170, 0, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        
        @media (max-width: 768px) {
          .sidebar {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 70px;
            margin: 0;
            flex-direction: row;
            top: auto;
            background: #ff0000;
            transform: none;
            z-index: 9999;
          }
          .sidebar-item {
            flex: 1 1 0;
            min-width: 0;
            min-height: 0;
            width: 50px;
            height: 50px;
            margin: 0 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 20px;
            color: white;
            background: transparent;
            transition: all 0.3s ease;
          }
          .sidebar-item.active {
            background: black;
            color: #ff0000;
          }
          .sidebar-item:hover {
            background: rgba(0, 0, 0, 0.2);
            transform: scale(1.1);
          }
        }
    </style>
</head>
<body class="text-white min-h-screen">
    <!-- Header with Logo -->
    <div class="fixed top-0 left-0 p-8 z-50">
        <div>
            <img src="images/lg.png" alt="My Desire Salon" class="h-16 brightness-0 invert cursor-pointer" onclick="window.location.href='index.html'">
        </div>
    </div>
      <div class="sidebar">
        <a href="index.html" class="sidebar-item active"><i class="fas fa-home"></i></a>
        <a href="chat.html" class="sidebar-item" id="chatToggle"><i class="fas fa-comments"></i></a>
        <a href="gallery.html" class="sidebar-item"><i class="fas fa-images"></i></a>
        <a href="contact.html" class="sidebar-item"><i class="fas fa-phone-volume"></i></a>
        <a href="profile.html" class="sidebar-item"><i class="fas fa-user"></i></a>
        <a href="settings.html" class="sidebar-item"><i class="fas fa-cog"></i></a>
        <div class="sidebar-item"><i class="fas fa-shop"></i></div>
    </div>
    <!-- Main Booking Content -->
    <div class="pt-32 pb-20 px-4">
        <div class="max-w-6xl mx-auto">
            <!-- Page Title -->
            <div class="text-center mb-12">
                <h1 class="text-5xl md:text-6xl font-bold mb-4">
                    <span class="text-primary">BOOK YOUR</span><br>
                    <span class="text-white">APPOINTMENT</span>
                </h1>
                <p class="text-xl text-gray-300">Choose your preferred stylist, service, and time</p>
            </div>

            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Left Column - Staff Selection -->
                <div class="booking-card p-6">
                    <h2 class="text-2xl font-bold mb-6 text-primary">Select Your Stylist</h2>
                    <div class="space-y-4" id="staffSelection">
                        <!-- Staff cards will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Middle Column - Services & Pricing -->
                <div class="booking-card p-6">
                    <h2 class="text-2xl font-bold mb-6 text-primary">Choose Service</h2>
                    <div class="space-y-3" id="serviceSelection">
                        <!-- Services will be populated by JavaScript -->
                    </div>

                    <!-- Price Range Display -->
                    <div class="price-range mt-6 p-4">
                        <h3 class="text-lg font-semibold mb-2">Estimated Price</h3>
                        <div class="flex justify-between items-center">
                            <span class="text-2xl font-bold text-primary" id="priceDisplay">KSh0 - KSh0</span>
                            <span class="text-sm text-gray-400">Negotiable</span>
                        </div>
                        <div class="mt-3">
                            <label class="block text-sm mb-2">Your Budget Range</label>
                            <input type="range" id="budgetRange" min="20" max="300" value="100" class="w-full accent-red-500">
                            <div class="flex justify-between text-sm text-gray-400">
                                <span>Ksh20</span>
                                <span id="budgetValue">Ksh100</span>
                                <span>Ksh300</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Date & Time -->
                <div class="booking-card p-6">
                    <h2 class="text-2xl font-bold mb-6 text-primary">Select Date & Time</h2>
                    
                    <!-- Calendar -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3">Choose Date</h3>
                        <div class="grid grid-cols-7 gap-2 text-center">
                            <div class="text-xs text-gray-400 p-2">Sun</div>
                            <div class="text-xs text-gray-400 p-2">Mon</div>
                            <div class="text-xs text-gray-400 p-2">Tue</div>
                            <div class="text-xs text-gray-400 p-2">Wed</div>
                            <div class="text-xs text-gray-400 p-2">Thu</div>
                            <div class="text-xs text-gray-400 p-2">Fri</div>
                            <div class="text-xs text-gray-400 p-2">Sat</div>
                            <!-- Calendar days will be populated by JavaScript -->
                            <div id="calendarDays"></div>
                        </div>
                    </div>

                    <!-- Time Slots -->
                    <div>
                        <h3 class="text-lg font-semibold mb-3">Available Times</h3>
                        <div class="grid grid-cols-3 gap-2" id="timeSlots">
                            <!-- Time slots will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Duration Estimate -->
                    <div class="mt-4 p-3 bg-gray-800 rounded-lg">
                        <div class="flex justify-between">
                            <span>Estimated Duration:</span>
                            <span id="durationDisplay" class="text-primary font-bold">0 mins</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Information Form -->
            <div class="booking-card p-6 mt-8">
                <h2 class="text-2xl font-bold mb-6 text-primary">Your Information</h2>
                <div id="errorMessage" class="error-message"></div>
                <div id="successMessage" class="success-message"></div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium mb-2">Full Name *</label>
                        <input type="text" id="customerName" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Phone Number *</label>
                        <input type="tel" id="customerPhone" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Email</label>
                        <input type="email" id="customerEmail" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Preferred Contact</label>
                        <select id="contactMethod" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none">
                            <option value="phone">Phone Call</option>
                            <option value="sms">SMS</option>
                            <option value="email">Email</option>
                            <option value="whatsapp">WhatsApp</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-medium mb-2">Special Requests / Notes</label>
                    <textarea id="specialRequests" rows="3" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none" placeholder="Any special requests or hair concerns..."></textarea>
                </div>
            </div>

            <!-- Booking Summary & Submit -->
            <div class="booking-card p-6 mt-8">
                <h2 class="text-2xl font-bold mb-6 text-primary">Booking Summary</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span>Stylist:</span>
                            <span id="selectedStaff" class="font-medium">Not selected</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Service:</span>
                            <span id="selectedService" class="font-medium">Not selected</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Date:</span>
                            <span id="selectedDate" class="font-medium">Not selected</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Time:</span>
                            <span id="selectedTime" class="font-medium">Not selected</span>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span>Duration:</span>
                            <span id="summaryDuration" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Price Range:</span>
                            <span id="summaryPrice" class="font-medium text-primary">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Your Budget:</span>
                            <span id="summaryBudget" class="font-medium">$100</span>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 text-center">
                    <button id="bookNowBtn" class="glow-button px-12 py-4 text-xl font-bold rounded-lg text-white">
                        <i class="fas fa-calendar-check mr-2"></i>
                        BOOK APPOINTMENT
                    </button>
                    <p class="text-sm text-gray-400 mt-2">You'll receive a confirmation call within 30 minutes</p>
                </div>
            </div>
        </div>
    </div>
   <script>
    // API base URL
    const API_BASE_URL = 'http://localhost:8000';
    
    // Data arrays
    let staffData = [];
    let servicesData = [
        { id: 1, name: "Haircut & Blow Dry", minPrice: 50, maxPrice: 100, duration: 30 },
        { id: 2, name: "Hair Coloring", minPrice: 100, maxPrice: 200, duration: 120 },
        { id: 3, name: "Highlights", minPrice: 200, maxPrice: 500, duration: 150 },
        { id: 4, name: "Perm", minPrice: 70, maxPrice: 130, duration: 180 },
        { id: 5, name: "Deep Conditioning Treatment", minPrice: 300, maxPrice: 600, duration: 45 },
        { id: 6, name: "Bridal Hair Styling", minPrice: 2000, maxPrice: 5000, duration: 90 },
        { id: 7, name: "Hair Extensions", minPrice: 1000, maxPrice: 2000, duration: 180 },
        { id: 8, name: "Keratin Treatment", minPrice: 1000, maxPrice: 2000, duration: 210 }
    ];
    const timeSlots = [
        "9:00 AM", "9:30 AM", "10:00 AM", "10:30 AM", "11:00 AM", "11:30 AM",
        "12:00 PM", "12:30 PM", "1:00 PM", "1:30 PM", "2:00 PM", "2:30 PM",
        "3:00 PM", "3:30 PM", "4:00 PM", "4:30 PM", "5:00 PM", "5:30 PM", "6:00 PM"
    ];

    let selectedStaff = null;
    let selectedService = null;
    let selectedDate = null;
    let selectedTime = null;
    let currentUserId = null;

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        // Check if user is logged in
        currentUserId = localStorage.getItem('userId');
        if (!currentUserId) {
            // Redirect to login if not logged in
            window.location.href = 'login.html';
            return;
        }
        
        fetchStaff();
        populateServices();
        populateCalendar();
        populateTimeSlots();
        setupEventListeners();
        loadUserProfile();
    });

    // Load user profile to prefill form
    async function loadUserProfile() {
        if (!currentUserId) return;
        
        try {
            const response = await fetch(`${API_BASE_URL}/users/${currentUserId}`);
            if (response.ok) {
                const userData = await response.json();
                document.getElementById('customerName').value = userData.name || '';
                document.getElementById('customerPhone').value = userData.phone || '';
                document.getElementById('customerEmail').value = userData.email || '';
            }
        } catch (error) {
            console.error('Error loading user profile:', error);
        }
    }

    // Fetch staff data from API
    async function fetchStaff() {
        try {
            const response = await fetch(`${API_BASE_URL}/attendants/`);
            if (response.ok) {
                staffData = await response.json();
                populateStaff();
            } else {
                console.error('Failed to fetch staff data');
                staffData = [
                    { id: 1, name: "Harrison", specialty: "Hair Cutting & Styling", experience: "5+ years", rating: 4.9, image: "https://via.placeholder.com/80x80/ff0000/ffffff?text=SJ" },
                    { id: 2, name: "Maria Rodriguez", specialty: "Hair Coloring & Highlights", experience: "7+ years", rating: 4.8, image: "https://via.placeholder.com/80x80/ff0000/ffffff?text=MR" },
                    { id: 3, name: "Ashley Kim", specialty: "Perms & Treatments", experience: "6+ years", rating: 4.9, image: "https://via.placeholder.com/80x80/ff0000/ffffff?text=AK" },
                    { id: 4, name: "Jennifer White", specialty: "Bridal & Special Events", experience: "8+ years", rating: 5.0, image: "https://via.placeholder.com/80x80/ff0000/ffffff?text=JW" }
                ];
                populateStaff();
            }
        } catch (error) {
            console.error('Error fetching staff data:', error);
            staffData = [
                { id: 1, name: "Harrison", specialty: "Hair Cutting & Styling", experience: "5+ years", rating: 4.9, image: "https://via.placeholder.com/80x80/ff0000/ffffff?text=SJ" },
                { id: 2, name: "Maria Rodriguez", specialty: "Hair Coloring & Highlights", experience: "7+ years", rating: 4.8, image: "https://via.placeholder.com/80x80/ff0000/ffffff?text=MR" },
                { id: 3, name: "Ashley Kim", specialty: "Perms & Treatments", experience: "6+ years", rating: 4.9, image: "https://via.placeholder.com/80x80/ff0000/ffffff?text=AK" },
                { id: 4, name: "Jennifer White", specialty: "Bridal & Special Events", experience: "8+ years", rating: 5.0, image: "https://via.placeholder.com/80x80/ff0000/ffffff?text=JW" }
            ];
            populateStaff();
        }
    }

    function populateStaff() {
        const staffContainer = document.getElementById('staffSelection');
        staffContainer.innerHTML = '';
        staffData.forEach(staff => {
            const staffCard = document.createElement('div');
            staffCard.className = 'staff-card p-4';
            const imageUrl = staff.image || `https://via.placeholder.com/80x80/ff0000/ffffff?text=${staff.name.charAt(0)}`;
            staffCard.innerHTML = `
                <div class="flex items-center space-x-4">
                    <img src="${imageUrl}" alt="${staff.name}" class="w-16 h-16 rounded-full">
                    <div class="flex-1">
                        <h3 class="font-semibold text-lg">${staff.name}</h3>
                        <p class="text-sm text-gray-400">${staff.specialty || 'Stylist'}</p>
                        <div class="flex items-center mt-1">
                            <span class="text-yellow-400 text-sm">★ ${staff.rating || 'N/A'}</span>
                            <span class="text-xs text-gray-500 ml-2">${staff.experience || 'Experience'}</span>
                        </div>
                    </div>
                </div>
            `;
            staffCard.addEventListener('click', () => selectStaff(staff, staffCard));
            staffContainer.appendChild(staffCard);
        });
    }

    function populateServices() {
        const servicesContainer = document.getElementById('serviceSelection');
        servicesContainer.innerHTML = '';
        servicesData.forEach(service => {
            const serviceItem = document.createElement('div');
            serviceItem.className = 'service-item p-4';
            serviceItem.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <h4 class="font-medium">${service.name}</h4>
                        <p class="text-sm text-gray-400">${service.duration} minutes</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-primary">Ksh ${service.minPrice} - Ksh${service.maxPrice}</p>
                    </div>
                </div>
            `;
            serviceItem.addEventListener('click', () => selectService(service, serviceItem));
            servicesContainer.appendChild(serviceItem);
        });
    }

    function populateCalendar() {
        const calendarContainer = document.getElementById('calendarDays');
        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

        // Clear existing calendar
        calendarContainer.innerHTML = '';

        for (let i = 0; i < firstDay; i++) {
            const emptyDay = document.createElement('div');
            calendarContainer.appendChild(emptyDay);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dayElement = document.createElement('div');
            const date = new Date(currentYear, currentMonth, day);
            const isToday = date.toDateString() === today.toDateString();
            const isPast = date < today;
            dayElement.className = `calendar-day p-2 text-center rounded ${isPast ? 'unavailable' : ''}`;
            dayElement.textContent = day;
            if (isToday) dayElement.classList.add('border-2', 'border-yellow-400');
            if (!isPast) dayElement.addEventListener('click', () => selectDate(date, dayElement));
            calendarContainer.appendChild(dayElement);
        }
    }

    function populateTimeSlots() {
        const timeSlotsContainer = document.getElementById('timeSlots');
        timeSlotsContainer.innerHTML = '';
        timeSlots.forEach(time => {
            const timeSlot = document.createElement('div');
            timeSlot.className = 'time-slot p-2 text-center text-sm';
            timeSlot.textContent = time;
            timeSlot.addEventListener('click', () => selectTime(time, timeSlot));
            timeSlotsContainer.appendChild(timeSlot);
        });
    }

    function selectStaff(staff, element) {
        document.querySelectorAll('.staff-card').forEach(card => card.classList.remove('selected'));
        element.classList.add('selected');
        selectedStaff = staff;
        updateSummary();
    }

    function selectService(service, element) {
        document.querySelectorAll('.service-item').forEach(item => item.classList.remove('selected'));
        element.classList.add('selected');
        selectedService = service;
        document.getElementById('priceDisplay').textContent = `Ksh${service.minPrice} - Ksh${service.maxPrice}`;
        document.getElementById('durationDisplay').textContent = `${service.duration} mins`;
        updateSummary();
    }

    function selectDate(date, element) {
        document.querySelectorAll('.calendar-day').forEach(day => day.classList.remove('selected'));
        element.classList.add('selected');
        selectedDate = date;
        updateSummary();
    }

    function selectTime(time, element) {
        document.querySelectorAll('.time-slot').forEach(slot => slot.classList.remove('selected'));
        element.classList.add('selected');
        selectedTime = time;
        updateSummary();
    }

    function setupEventListeners() {
        const budgetRange = document.getElementById('budgetRange');
        const budgetValue = document.getElementById('budgetValue');
        budgetRange.addEventListener('input', function() {
            budgetValue.textContent = `Ksh${this.value}`;
            document.getElementById('summaryBudget').textContent = `Ksh${this.value}`;
        });
        document.getElementById('bookNowBtn').addEventListener('click', bookAppointment);
    }

    function updateSummary() {
        document.getElementById('selectedStaff').textContent = selectedStaff ? selectedStaff.name : 'Not selected';
        document.getElementById('selectedService').textContent = selectedService ? selectedService.name : 'Not selected';
        document.getElementById('selectedDate').textContent = selectedDate ? selectedDate.toLocaleDateString() : 'Not selected';
        document.getElementById('selectedTime').textContent = selectedTime || 'Not selected';
        if (selectedService) {
            document.getElementById('summaryDuration').textContent = `${selectedService.duration} mins`;
            document.getElementById('summaryPrice').textContent = `Ksh${selectedService.minPrice} - Ksh${selectedService.maxPrice}`;
        }
    }

    async function bookAppointment() {
        try {
            console.log('Starting appointment booking process');
            const name = document.getElementById('customerName').value;
            const phone = document.getElementById('customerPhone').value;
            const email = document.getElementById('customerEmail').value || `${name.replace(/\s+/g, '')}@mydesiresalon.com`;
            const specialRequests = document.getElementById('specialRequests').value;
            const contactMethod = document.getElementById('contactMethod').value;
            
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            
            // Hide messages
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            
            console.log('Form data:', { name, phone, email, specialRequests, contactMethod });

            if (!name || !phone) {
                console.log('Validation failed: name or phone missing');
                errorMessage.textContent = 'Please fill in your name and phone number';
                errorMessage.style.display = 'block';
                return;
            }

            if (!selectedStaff || !selectedService || !selectedDate || !selectedTime) {
                console.log('Validation failed: selections missing');
                errorMessage.textContent = 'Please select a stylist, service, date, and time';
                errorMessage.style.display = 'block';
                return;
            }

            // Format date and time for the API
            const formattedDate = selectedDate.toISOString().split('T')[0];
            let formattedTime = selectedTime;
            
            // Parse time properly
            let hours, minutes;
            if (formattedTime.includes('AM')) {
                const timePart = formattedTime.replace(' AM', '');
                [hours, minutes] = timePart.split(':').map(Number);
                // Convert 12 AM to 0 hours
                if (hours === 12) hours = 0;
            } else if (formattedTime.includes('PM')) {
                const timePart = formattedTime.replace(' PM', '');
                [hours, minutes] = timePart.split(':').map(Number);
                // Add 12 hours for PM (except 12 PM)
                if (hours !== 12) hours += 12;
            } else {
                // 24-hour format
                [hours, minutes] = formattedTime.split(':').map(Number);
            }
            
            // Format hours and minutes with leading zeros
            const formattedHours = hours.toString().padStart(2, '0');
            const formattedMinutes = minutes.toString().padStart(2, '0');
            
            // Combine date and time for the appointment
            const appointmentDateTime = new Date(`${formattedDate}T${formattedHours}:${formattedMinutes}:00`);
            console.log('Formatted appointment date/time:', appointmentDateTime);

            const appointmentData = {
                service: selectedService.name,
                user_id: parseInt(currentUserId),
                attendant_id: selectedStaff.id,
                scheduled_time: appointmentDateTime.toISOString()
            };
            
            console.log('Sending appointment data:', appointmentData);

            try {
                console.log('Making API call to:', `${API_BASE_URL}/appointments/`);
                const response = await fetch(`${API_BASE_URL}/appointments/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(appointmentData)
                });
                console.log('API response status:', response.status);
                console.log('API response headers:', response.headers);

                const result = await response.json();
                console.log('API response data:', result);
                
                if (response.ok) {
                    console.log('Booking successful');
                    successMessage.textContent = `Booking confirmed! You'll receive a confirmation via ${contactMethod} within 30 minutes.`;
                    successMessage.style.display = 'block';
                    console.log('Success message displayed');
                    
                    // Reset form and selections
                    document.getElementById('specialRequests').value = '';
                    document.querySelectorAll('.staff-card.selected').forEach(card => card.classList.remove('selected'));
                    document.querySelectorAll('.service-item.selected').forEach(item => item.classList.remove('selected'));
                    document.querySelectorAll('.calendar-day.selected').forEach(day => day.classList.remove('selected'));
                    document.querySelectorAll('.time-slot.selected').forEach(slot => slot.classList.remove('selected'));
                    selectedStaff = null;
                    selectedService = null;
                    selectedDate = null;
                    selectedTime = null;
                    updateSummary();
                    
                    // Reload user profile to ensure data is current
                    loadUserProfile();
                } else {
                    console.log('Booking failed with status:', response.status);
                    errorMessage.textContent = result.detail || 'Failed to book appointment';
                    errorMessage.style.display = 'block';
                    console.log('Error message displayed');
                }
            } catch (fetchError) {
                console.error('Error making API call:', fetchError);
                errorMessage.textContent = 'Unable to connect to the server. Please check your internet connection and try again.';
                errorMessage.style.display = 'block';
                console.log('Connection error message displayed');
            }
        } catch (error) {
            console.error('Unexpected error in bookAppointment:', error);
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = 'An unexpected error occurred. Please try again.';
            errorMessage.style.display = 'block';
            console.log('Unexpected error message displayed');
        }
    }
</script>